#!/bin/sh
# Script to set dwm status bar and response to mouse clicks

# If you clicked some text after a delimiter \0NN in the status bar,
# the hexadecimal value of it will be passed as $1
[ "${#1}" -eq 1 ] && INDEX=$(printf "%02o" $((0x$1)))
case "${INDEX:-$1}" in
    "$INET")
        case "$BUTTON" in
            1) notify "dwm status"  "$(cat $TMPDIR/$SNET-tooltip)" & ;;
        esac ;;
    "$IMAIL")
        case "${BUTTON-1}" in
            1) rofi -theme launcher -show drun & ;;
            3) $TERMINAL -e mutt ;;
        esac ;;
    "$IMPD")
        case "$BUTTON" in
            1) notify "dwm status"  "$(mpc)" & ;;
            3) $FLOATTERM -e ncmpc ;;
        esac ;;
esac

if [ -z "$STR_NET" ] || [ $((TIME - TIME_NET)) -gt $NNET ]; then
    IFS='|' read -r WIFI_SSID WIFI_LEVEL _ << EOF
$(network -wc | tr '\n' '|')
EOF
    STR_NET=$(echo "$WIFI_ICONS" | cut -d ' ' -f "$WIFI_INDEX")
    echo "$TIME $STR_NET" > $TMPDIR/$SNET
    echo "Wifi: $WIFI_SSID Signal: $WIFI_LEVEL" > $TMPDIR/$SNET-tooltip
fi

STR_IMAP=
for mail in ~/.config/mutt/*@*.muttrc; do
    mail_address=$(basename "$mail" .muttrc)
    # count=$(imap "$mail_address")
    total_mail=$((total_mail + count))
    if grep -q "$mail_address" "$TMPDIR/$SMAIL"; then
        sed -i "s/$mail_address ([0-9]*)/$mail_address ($count)/" "$TMPDIR/$SMAIL"
    else
        echo "$mail_address ($count)" >> "$TMPDIR/$SMAIL"
    fi
    STR_IMAP="$STR_IMAP${STR_IMAP:+/}$count"
done
if [ "$total_mail" -gt 0 ]; then ICON_MAIL="󰇮"; else ICON_MAIL="󰇰"; fi

printf " \021\0$IMAIL%s%s \0$INULL"  "$ICON_MAIL" "$STR_IMAP"
